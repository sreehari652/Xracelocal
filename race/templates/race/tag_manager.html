<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Race Display</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#0f1117;color:#e2e8f0;font-family:'Segoe UI',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}
  .top{display:flex;align-items:center;gap:14px;padding:10px 18px;background:#1a1d2e;border-bottom:1px solid #2e3148;flex-shrink:0}
  .top select{padding:8px 12px;border-radius:6px;border:1px solid #3a3f5c;background:#151720;color:#e2e8f0;font-size:.9rem;min-width:200px;outline:none;cursor:pointer}
  .top select:focus{border-color:#6c63ff}
  .ws{font-size:.78rem;padding:3px 10px;border-radius:12px;background:#2e3148;color:#94a3b8}
  .ws.on{background:#16a34a33;color:#4ade80}
  .ws.off{background:#dc262633;color:#f87171}
  .body{display:flex;flex:1;overflow:hidden}
  .cv-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:12px}
  canvas{border-radius:10px;border:1px solid #2e3148;background:#151720}
  .side{width:240px;background:#1a1d2e;border-left:1px solid #2e3148;overflow-y:auto;padding:12px;flex-shrink:0}
  .side h3{font-size:.9rem;color:#6c63ff;margin-bottom:10px;border-bottom:1px solid #2e3148;padding-bottom:5px}
  .card{background:#151720;border-radius:8px;padding:9px 11px;margin-bottom:7px;border-left:4px solid #2e3148;display:flex;align-items:center;gap:9px}
  .card.live{border-left-color:var(--c)}
  .card .name{font-size:.85rem;font-weight:600;color:#fff}
  .card .info{font-size:.72rem;color:#64748b;margin-top:2px}
  .card .pos{font-size:.72rem;color:#4ade80;font-weight:600}
  .ph{color:#4a4f6a;font-size:.85rem;text-align:center;padding:30px 0}
</style>
</head>
<body>

<div class="top">
  <select id="tSel" onchange="loadGroups()"><option value="">‚Äî Tournament ‚Äî</option></select>
  <select id="gSel" onchange="selectGroup()" disabled><option value="">‚Äî Group ‚Äî</option></select>
  <span class="ws off" id="wsS">‚óè Disconnected</span>
</div>

<div class="body">
  <div class="cv-wrap"><canvas id="c" width="780" height="560"></canvas></div>
  <div class="side">
    <h3>üèÅ Players</h3>
    <div id="lb"><p class="ph">Select a group</p></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ
const BASE = 'https://xraceapi.zyberspace.in';
const API  = { list: BASE+'/api/tournaments/', struct: BASE+'/api/tournament-structure/', players: BASE+'/api/group-players/' };

// WebSocket connects to YOUR local Django (not xraceapi)
const WS_URL = `ws://${window.location.host}/ws/race/`;

// Anchor positions in cm ‚Äî match your physical setup
const ANC = [{x:0,y:0},{x:430,y:0},{x:430,y:470},{x:0,y:470}];

const COLORS = ['#ff4757','#2ed573','#1e90ff','#ffa502','#a55eea','#ff6b81','#26de81','#45aaf2'];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let players = [];          // [{name, tag_id, color}]
let tagData  = {};         // { tag_id: {x, y, trail:[], lastTime} }
let watchTags = new Set(); // tag_ids for current group

// ‚îÄ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');
let scale, offX, offY;

function calcLayout() {
  const pad = 55;
  const maxX = Math.max(...ANC.map(a=>a.x));
  const maxY = Math.max(...ANC.map(a=>a.y));
  scale = Math.min((canvas.width-pad*2)/maxX, (canvas.height-pad*2)/maxY) * 0.85;
  offX  = (canvas.width  - maxX*scale) / 2;
  offY  = (canvas.height - maxY*scale) / 2;
}
calcLayout();

// cm ‚Üí pixel (Y flipped)
function toP(cx,cy){ return { px: offX+cx*scale, py: canvas.height-offY-cy*scale }; }

// ‚îÄ‚îÄ‚îÄ TRILATERATION ‚îÄ‚îÄ‚îÄ
function trilaterate(ranges) {
  const v = [];
  ranges.forEach((r,i) => { if(r>0 && i<ANC.length) v.push({ax:ANC[i].x, ay:ANC[i].y, r}); });
  if(v.length<3) return null;

  const [a,b,c] = v;
  const A=2*(b.ax-a.ax), B=2*(b.ay-a.ay);
  const C=a.r**2-b.r**2-a.ax**2+b.ax**2-a.ay**2+b.ay**2;
  const D=2*(c.ax-b.ax), E=2*(c.ay-b.ay);
  const F=b.r**2-c.r**2-b.ax**2+c.ax**2-b.ay**2+c.ay**2;
  const den=A*E-B*D;
  if(Math.abs(den)<0.001) return null;
  return { x:(C*E-F*B)/den, y:(A*F-C*D)/den };
}

// ‚îÄ‚îÄ‚îÄ DRAW LOOP ‚îÄ‚îÄ‚îÄ
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Grid
  ctx.strokeStyle='#1e2130'; ctx.lineWidth=1;
  const mxX=Math.max(...ANC.map(a=>a.x)), mxY=Math.max(...ANC.map(a=>a.y));
  for(let x=0;x<=mxX;x+=50){ const a=toP(x,0),b=toP(x,mxY); ctx.beginPath();ctx.moveTo(a.px,a.py);ctx.lineTo(b.px,b.py);ctx.stroke(); }
  for(let y=0;y<=mxY;y+=50){ const a=toP(0,y),b=toP(mxX,y); ctx.beginPath();ctx.moveTo(a.px,a.py);ctx.lineTo(b.px,b.py);ctx.stroke(); }

  // Boundary
  ctx.strokeStyle='#6c63ff'; ctx.lineWidth=2.5; ctx.beginPath();
  ANC.forEach((a,i)=>{ const p=toP(a.x,a.y); i===0?ctx.moveTo(p.px,p.py):ctx.lineTo(p.px,p.py); });
  ctx.closePath(); ctx.stroke();

  // Anchor labels
  ANC.forEach((a,i)=>{
    const p=toP(a.x,a.y);
    ctx.fillStyle='#6c63ff'; ctx.beginPath();ctx.arc(p.px,p.py,6,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#94a3b8'; ctx.font='11px Segoe UI'; ctx.fillText('A'+i,p.px+9,p.py-7);
  });

  // Players: trail + dot + label ‚Äî ONLY if data exists for their tag
  const now = Date.now();
  players.forEach(pl => {
    if(!pl.tag_id || !tagData[pl.tag_id]) return;   // no data yet ‚Üí skip, don't draw

    const d = tagData[pl.tag_id];

    // If no update in last 3 seconds, don't draw (stale)
    if(now - d.lastTime > 3000) return;

    // Trail
    if(d.trail.length>1){
      ctx.strokeStyle=pl.color; ctx.lineWidth=2.5; ctx.globalAlpha=0.35;
      ctx.beginPath();
      d.trail.forEach((pt,i)=>{ const p=toP(pt.x,pt.y); i===0?ctx.moveTo(p.px,p.py):ctx.lineTo(p.px,p.py); });
      ctx.stroke(); ctx.globalAlpha=1;
    }

    // Car dot + glow
    const p=toP(d.x, d.y);
    ctx.shadowColor=pl.color; ctx.shadowBlur=14;
    ctx.fillStyle=pl.color; ctx.beginPath();ctx.arc(p.px,p.py,11,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;

    // White ring
    ctx.strokeStyle='#fff'; ctx.lineWidth=2.5;
    ctx.beginPath();ctx.arc(p.px,p.py,11,0,Math.PI*2);ctx.stroke();

    // Name label above
    ctx.fillStyle='#fff'; ctx.font='bold 13px Segoe UI'; ctx.textAlign='center';
    ctx.fillText(pl.name, p.px, p.py-18);
    ctx.textAlign='left';
  });

  requestAnimationFrame(draw);
}
draw();

// ‚îÄ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ‚îÄ
let ws;
function connectWS(){
  if(ws) ws.close();
  ws = new WebSocket(WS_URL);

  ws.onopen = ()=>{
    document.getElementById('wsS').className='ws on';
    document.getElementById('wsS').textContent='‚óè Connected';
  };
  ws.onclose = ()=>{
    document.getElementById('wsS').className='ws off';
    document.getElementById('wsS').textContent='‚óè Disconnected';
    setTimeout(connectWS, 2000); // auto-reconnect
  };
  ws.onerror = ()=>{};

  ws.onmessage = (e)=>{
    const msg = JSON.parse(e.data);
    if(msg.type !== 'tag_position') return;

    const tid = msg.tag_id;

    // ONLY process if this tag belongs to selected group
    if(!watchTags.has(tid)) return;

    const pos = trilaterate(msg.range);
    if(!pos) return;

    // Init
    if(!tagData[tid]) tagData[tid] = {x:0, y:0, trail:[], lastTime:0};

    tagData[tid].x = pos.x;
    tagData[tid].y = pos.y;
    tagData[tid].lastTime = Date.now();

    // Trail (keep 60 points)
    tagData[tid].trail.push({x:pos.x, y:pos.y});
    if(tagData[tid].trail.length > 60) tagData[tid].trail.shift();

    // Update sidebar live
    updateSidebar();
  };
}
connectWS();

// ‚îÄ‚îÄ‚îÄ API helper ‚îÄ‚îÄ‚îÄ
async function get(url){ return (await fetch(url,{credentials:'include'})).json(); }

// ‚îÄ‚îÄ‚îÄ LOAD TOURNAMENTS ‚îÄ‚îÄ‚îÄ
async function loadTournaments(){
  const {data} = await get(API.list);
  const sel = document.getElementById('tSel');
  data.forEach(t=>{
    const o = document.createElement('option');
    o.value = t.slug; o.textContent = t.name;
    sel.appendChild(o);
  });
}

// ‚îÄ‚îÄ‚îÄ LOAD GROUPS ‚îÄ‚îÄ‚îÄ
async function loadGroups(){
  const slug = document.getElementById('tSel').value;
  const gSel = document.getElementById('gSel');
  gSel.innerHTML='<option value="">‚Äî Group ‚Äî</option>';
  gSel.disabled = true;
  if(!slug) return;

  const {data} = await get(API.struct+'?slug='+slug);
  if(!data?.rounds) return;
  gSel.disabled = false;

  data.rounds.forEach(r=>{
    const og = document.createElement('optgroup');
    og.label = `Round ${r.round_no} ‚Äî ${r.round_name}${r.is_final?' üèÜ':''}`;
    r.groups.forEach(g=>{
      const o = document.createElement('option');
      o.value = g.group_id;
      o.textContent = g.group_name + (g.group_status?` [${g.group_status}]`:'');
      og.appendChild(o);
    });
    gSel.appendChild(og);
  });
}

// ‚îÄ‚îÄ‚îÄ SELECT GROUP ‚Üí load players ‚Üí set watchTags ‚îÄ‚îÄ‚îÄ
async function selectGroup(){
  const gid = document.getElementById('gSel').value;

  // Reset everything
  players   = [];
  tagData   = {};
  watchTags = new Set();

  if(!gid){ renderSidebar(); return; }

  const {data} = await get(API.players+'?group_id='+gid);

  data.forEach((p,i)=>{
    players.push({ name: p.player_name, tag_id: p.tag_id, color: COLORS[i%COLORS.length] });
    if(p.tag_id) watchTags.add(p.tag_id);  // from now on, WS will process these tags
  });

  renderSidebar();
}

// ‚îÄ‚îÄ‚îÄ SIDEBAR: show all players, mark live if data is flowing ‚îÄ‚îÄ‚îÄ
function renderSidebar(){
  const lb = document.getElementById('lb');
  if(!players.length){ lb.innerHTML='<p class="ph">No players</p>'; return; }

  lb.innerHTML = players.map(p=>{
    const hasData = p.tag_id && tagData[p.tag_id];
    const isLive  = hasData && (Date.now()-tagData[p.tag_id].lastTime < 3000);
    return `
      <div class="card ${isLive?'live':''}" style="--c:${p.color}; ${isLive?'border-left-color:'+p.color:''}">
        <div style="width:12px;height:12px;border-radius:50%;background:${isLive?p.color:'#2e3148'}"></div>
        <div>
          <div class="name">${p.name}</div>
          <div class="info">
            ${p.tag_id ? 'Tag: '+p.tag_id+'  ' : '<span style="color:#4a4f6a;font-style:italic">No tag</span>'}
            ${isLive ? `<span class="pos" id="pos-${p.tag_id}">x:${tagData[p.tag_id].x.toFixed(0)} y:${tagData[p.tag_id].y.toFixed(0)}</span>` : (p.tag_id?'<span style="color:#4a4f6a">Waiting‚Ä¶</span>':'')}
          </div>
        </div>
      </div>`;
  }).join('');
}

// lightweight update ‚Äî just swap the position text, no full re-render
function updateSidebar(){
  players.forEach(p=>{
    if(!p.tag_id || !tagData[p.tag_id]) return;
    const el = document.getElementById('pos-'+p.tag_id);
    if(el){
      el.textContent = `x:${tagData[p.tag_id].x.toFixed(0)} y:${tagData[p.tag_id].y.toFixed(0)}`;
    } else {
      // first time this tag got data ‚Äî need full render to show it
      renderSidebar();
    }
  });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
loadTournaments();
</script>
</body>
</html>